# Raspi-Storage

Данный проект создан для автоматического копирования данных с внешнего носителя (подключаемого через USB-Port) на карту памяти Raspberry Pi.
Предназначен он, в первую очередь, для путешественников, позволяя быстро создавать резервные копии фото и видео материала (а так же любых других данных), при этом экономя на весе / объеме дополнительного чувствительного оборудования. За основу был взят и переработан проект "Little Backup Box" (https://github.com/dmpop/little-backup-box)

# Основные функции:

- Резервная копия создается на карту памяти встроенную в Raspberry Pi. В следствие чего, отпадает необходимость в дополнительных носителях и снижается риск потери данных.
- Доступ к данным (с использованием пароля) через Samba-Server.
- Автоматическая синхронизация данных со встроенной карты памяти, при нахождении в своей(!) сети и NAS / PC.
- Подключение к "удаленному рабочему столу" и управление Raspberry Pi стандартными средствами Windows.
- Автоматическое отключение Raspi-Storage по окнчании работы, а так же, при неиспользовании или случайном включении.
- Оптическая сигнализация текущих действий.


# Установка Raspi-Storage:

Для установки вам понадобятся минимальные компьютерные знания и следующие программы:
- Образ Raspbian (c Lite версией не тестировал): https://www.raspberrypi.org/downloads/raspbian/
- Программа для форматирования SD карты "SD Memory Card Formatter": https://www.sdcard.org/downloads/formatter_4/index.html
- Программа для записи образа Raspbian на SD карту: https://sourceforge.net/projects/win32diskimager/
- Текстовый редактор (ни в коем случае нельзя использовать текстовые редакторы Windows!). Например бесплатный "Notepad++": https://notepad-plus-plus.org/download/
- Программа для коммуникации с Raspberry Pi по SSH "PuTTY": http://www.putty.org/

Установка:
- Скачиваем все 5 файлов.
- Открываем с помощью Notepad++ файл "wpa_supplicant.conf". Заменяем SsId на SSID  и PaSsWoRd на пароль вашего WiFi.
- Открываем с помощью Notepad++ файл "smb.conf" и заменяем Workgroup на название вашей рабочей группы.
Далее настраиваем файлы "*.sh" . Для удобства все коментарии начинаются с двух "##" , а закоментированные (отключенные) команды с одной "#"

- Открываем с помощью Notepad++ файл "backup.sh" и если вы собираетесь использовать синхронизацию с NAS (PC), то убираем "#" у команды "#sleep 15" в 22-ой строке. Это нужно, чтобы Raspberry Pi успел смонтировать папку. 
- Если вы не хотите, чтобы Raspi-Storage автоматически отключался при бездействии, то ставим решетку в 36 строке перед командой "sudo shutdown -h 7". При значинии меньшем 6 (минут) возникают проблемы с соединением по SSH.

- Открываем с помощью Notepad++ файл "raspi-storage-install.sh" и если вы собираетесь использовать синхронизацию с NAS (PC), то находим 86 (89 - для Windows) строку (после ## NAS - mount") и заменяем NAS_IP_Adresse/RaspiFolder на IP вашего сервера и путь к папке для синхронизации. Также заменяем UsErNaMe и UsErPaSsWoRd на ваш логин и пароль соответственно. Так же убираем решетки у 110 ("#read -rn1 -p "Press any key when ready" ; echo") и 111 ("#sudo raspi-config") строк.


После записи образа Raspbian на SD карту, копируем все 5 файлов на диск "Boot".
Вставлем карту в Raspberry Pi и включаем. Ждем пару минут, пока Raspberry Pi не настроится и не подключится к вашей сети (интернет необходим для установки).
Затем соединяемся с Raspberry Pi с помощью PuTTY: Host - Raspberrypi; Port - 22. Login: pi; Password: raspberry

Для установки Raspi-Storage вводим команду: bash /boot/raspi-storage-install.sh

# Работа с Raspi-Storage:

- После включения, Raspi-Storage ждет 15 секунд, после чего проверяет подключен ли он к серверу:
  Если да: начинает синхронизацию своих файлов с сервером, после чего переходит в режим ожидания "носителя" (Heartbreak).
  Если нет: сразу переходит в режим ожидания "носителя" (Heartbreak).
  
- Если "носитель" не обнаруживается за заданный промежуток времени (7 минут), то Raspi-Storage отключается для экономии энергии (если эта функция включена).

- При обнаружении носителя копируются только новые файлы на карту памяти. После чего происходит синхронизация с сервером, если тот подключен. После чего Raspi-Storage отключается.

- При включеном Raspi-Storage доступ к файлам возможен по сети. При удалении файлов, они перемещаются в корзину - ".recyclebin". Для полного удаления, нужно удалить их из корзины.
- Если вам необходим более длительный, чем 7 минут доступ к Raspi-Storage, то с помощью PuTTY отправьте команду "sudo shutdown -c" (без ковычек). Для последующего отключения отправьте команду "sudo shutdown -h".
- Для удаленного доступа используйте программу C:\Windows\System32\mstsc.exe

